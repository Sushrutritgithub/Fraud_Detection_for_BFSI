<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title>Fraud Alerts - BFSI Intelligence</title>
  <link rel="stylesheet" href="/static/css/styles.css?v=3">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .alert-card {
      background: rgba(231, 76, 60, 0.1);
      border-left: 4px solid #e74c3c;
      margin-bottom: 1rem;
      padding: 1.5rem;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .alert-info h3 {
      margin: 0 0 0.5rem 0;
      color: #ff7675;
    }

    .alert-meta {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .risk-badge {
      background: #e74c3c;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      text-transform: uppercase;
      font-weight: bold;
    }

    .ai-result {
      margin-top: 1rem;
      background: rgba(0, 0, 0, 0.3);
      padding: 1rem;
      border-radius: 8px;
      display: none;
      border: 1px solid var(--primary);
    }
  </style>
</head>

<body>
  <script src="/static/js/navbar.js?v=7"></script>

  <div class="container">
    <h1>Fraud Alerts & Risky Transactions</h1>
    <p>Real-time alerts generated by the detection engine. Use AI to investigate further.</p>

    <div id="alertsList" class="mt-2 text-center">
      <p>Loading alerts...</p>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', loadAlerts);

    async function loadAlerts() {
      const token = localStorage.getItem('token');
      if (!token) return;

      try {
        const API_BASE = window.location.protocol === 'file:' ? 'http://127.0.0.1:5000' : (window.location.port ? window.location.origin.replace(/:\d+$/, ':5000') : window.location.origin + ':5000');
        const res = await fetch(API_BASE + '/api/alerts', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const alerts = await res.json();

        const container = document.getElementById('alertsList');
        if (alerts.length === 0) {
          container.innerHTML = '<p>No high-risk transactions detected yet.</p>';
          return;
        }

        container.innerHTML = alerts.map(a => `
                    <div class="alert-card glass">
                        <div class="alert-info" style="text-align: left;">
                            <h3><span class="risk-badge">High Risk</span> Transaction #${a.transaction_id}</h3>
                            <div class="alert-meta">
                                Amount: <strong>₹${a.transaction_amount.toLocaleString()}</strong> | Channel: ${a.channel} | Customer: ${a.customer_id}
                                <br>Time: ${new Date(a.timestamp).toLocaleString()}
                            </div>
                        </div>
                        <div>
                            <button class="btn" onclick="analyzeTransaction('${a.transaction_id}', '${a.transaction_amount}', '${a.channel}', '${a.timestamp}')">
                                ✨ Ask AI
                            </button>
                        </div>
                    </div>
                    <div id="ai-result-${a.transaction_id}" class="ai-result text-left"></div>
                `).join('');
      } catch (err) {
        console.error(err);
        document.getElementById('alertsList').innerHTML = '<p class="error">Failed to load alerts.</p>';
      }
    }

    async function analyzeTransaction(id, amount, channel, timestamp) {
      const token = localStorage.getItem('token');
      const resultDiv = document.getElementById(`ai-result-${id}`);

      if (!resultDiv) {
        console.error('Result div not found for transaction:', id);
        return;
      }

      resultDiv.style.display = 'block';
      resultDiv.innerHTML = '<div style="text-align: center; padding: 1rem;"><i class="fas fa-spinner fa-spin"></i> Analyzing with AI...</div>';

      try {
        const API_BASE = window.location.protocol === 'file:' ? 'http://localhost:5000' : window.location.origin.replace(/:\d+$/, ':5000');
        const res = await fetch(API_BASE + '/api/analyze', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            amount: parseFloat(amount) || 0,
            channel: channel || 'Unknown',
            account_age: 'Unknown',
            kyc_verified: 'Unknown',
            timestamp: timestamp || new Date().toISOString()
          })
        });

        const data = await res.json();

        if (res.ok && data.analysis) {
          // Simple formatting for markdown-like text
          let formatted = data.analysis
            .replace(/\n\n/g, '</p><p>')
            .replace(/\n/g, '<br>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>');

          if (!formatted.includes('<p>')) {
            formatted = '<p>' + formatted + '</p>';
          }

          resultDiv.innerHTML = `<div style="background: rgba(46, 204, 113, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem;"><strong style="color: #2ecc71;">AI Analysis:</strong><br>${formatted}</div>`;
        } else {
          resultDiv.innerHTML = `<div style="color: #f39c12; padding: 1rem;">AI analysis unavailable: ${data.error || 'Service temporarily unavailable'}</div>`;
        }
      } catch (err) {
        console.error('AI analysis error:', err);
        resultDiv.innerHTML = '<div style="color: #e74c3c; padding: 1rem;">Error contacting AI service. Please try again later.</div>';
      }
    }
  </script>
  <!-- Curved Background Animation -->
  <script src="/static/js/curved-bg.js"></script>
</body>

</html>